<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bingo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link rel="stylesheet" href="/static/bingo.css">
</head>
<body class="body" :class="{'body-game-started': gameStarted}" x-data="bingoGame()">
    <header class="header">
        <div class="flex items-center space-x-1">
            <a href="/?token={{ request.args.get('token') }}" class="button button-green text-sm flex items-center space-x-1" x-show="!(gameStarted ?? false)" aria-label="Go back to home">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
                <span>Back</span>
            </a>
        </div>
        <div class="text-center">
            <h1 class="text-lg font-bold text-teal-400">Bingo</h1>
        </div>
        <div class="text-xs flex flex-col items-end">
            <span aria-label="Total cartellas">Cartellas: <span x-text="totalCartellas"></span>/100</span>
            <span aria-label="Total prize">Prize: <span x-text="totalPrize.toFixed(2)"></span> birr</span>
        </div>
    </header>

    <main class="flex-grow p-2" aria-label="Bingo game main content">
        <div class="max-w-sm mx-auto">
            <!-- Cartella Selection with Pattern Switch -->
            <div x-show="!gameStarted && !gameStarting && totalCartellas < 100">
                <div class="mb-4">
                    <h2 class="text-base font-bold mb-2 text-center">Pattern Type</h2>
                    <div class="flex justify-center items-center space-x-2">
                        <span class="text-sm">Single</span>
                        <label class="switch">
                            <input type="checkbox" @change="selectPattern($event.target.checked ? 'double' : 'single')" :checked="patternType === 'double'">
                            <span class="slider"></span>
                        </label>
                        <span class="text-sm">Double</span>
                    </div>
                    <p class="text-center text-xs text-gray-400 mt-2">
                        <span x-show="patternType === 'single'">Win with 1 pattern (easier)</span>
                        <span x-show="patternType === 'double'">Win with 2 patterns (harder, higher reward)</span>
                    </p>
                </div>

                <h2 class="text-base font-bold mb-2 text-center">Select Cartella Number (Up to 2)</h2>
                <p class="text-center text-xs text-gray-400 mb-2">Click a number to preview its cartella. Select up to 2 cartellas.</p>
                <div class="grid grid-cols-10 gap-1 mb-2" role="grid" aria-label="Cartella number selection grid">
                    <template x-for="num in 100" :key="num">
                        <div 
                            class="number-circle"
                            :class="{
                                'hover:bg-blue-600': !selectedCartellaNumbers.includes(num) && !takenCartellas.includes(num),
                                'number-circle-selected': selectedCartellaNumbers.includes(num),
                                'number-circle-unavailable': takenCartellas.includes(num) && !selectedCartellaNumbers.includes(num),
                                'button-disabled': (cartellas.length >= 2 && !selectedCartellaNumbers.includes(num)) || (takenCartellas.includes(num) && !selectedCartellaNumbers.includes(num))
                            }"
                            @click="cartellas.length < 2 && !takenCartellas.includes(num) && toggleCartellaNumber(num)"
                            :aria-label="'Cartella ' + num + (selectedCartellaNumbers.includes(num) ? ' (selected)' : takenCartellas.includes(num) ? ' (unavailable)' : '')"
                            role="button"
                        >
                            <span x-text="num"></span>
                        </div>
                    </template>
                </div>

                <p class="text-center text-yellow-400 text-xs mb-2" x-show="cartellas.length >= 2">Can't add more cartellas. You already have 2!</p>

                <div class="cartella mb-2" x-show="selectedCartellaNumbers.length > 0">
                    <h3 class="text-center font-bold text-sm mb-1">Cartella Preview</h3>
                    <div class="grid grid-cols-5 gap-1">
                        <div class="text-center font-bold text-yellow-400 text-xs">B</div>
                        <div class="text-center font-bold text-yellow-400 text-xs">I</div>
                        <div class="text-center font-bold text-yellow-400 text-xs">N</div>
                        <div class="text-center font-bold text-yellow-400 text-xs">G</div>
                        <div class="text-center font-bold text-yellow-400 text-xs">O</div>

                        <template x-for="row in 5" :key="row">
                            <template x-for="col in 5" :key="col">
                                <div 
                                    class="number-circle"
                                    :class="{'bg-yellow-600': currentCartella[row-1][col-1] === '*'}"
                                >
                                    <span x-text="currentCartella[row-1][col-1]"></span>
                                </div>
                            </template>
                        </template>
                    </div>
                </div>

                <div class="flex justify-center space-x-2 mb-2">
                    <button 
                        class="button button-green px-3 py-1 text-sm flex items-center space-x-1"
                        @click="confirmCartellas()"
                        :disabled="selectedCartellaNumbers.length === 0"
                        x-show="cartellas.length === 0"
                        aria-label="Confirm selected cartellas"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        <span>Check</span>
                    </button>
                    <button 
                        class="button button-red px-3 py-1 text-sm flex items-center space-x-1"
                        @click="cancelCartellas()"
                        x-show="cartellas.length > 0"
                        aria-label="Cancel selected cartellas"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                        <span>Cancel</span>
                    </button>
                </div>

                <p class="text-center text-xs text-gray-400" x-show="cartellas.length > 0 && !gameStarted && !gameStarting">
                    Waiting for at least 5 cartellas to start the game... (<span x-text="cartellas.length"></span>/2 selected)
                </p>
            </div>

            <!-- Countdown Before Game Start -->
            <div x-show="gameStarting && !gameStarted" class="text-center mb-2">
                <h2 class="text-base font-bold mb-1">Game Starting...</h2>
                <div class="countdown" x-text="countdown + 's'"></div>
            </div>

            <!-- Game Play -->
            <div x-show="gameStarted">
                <div class="flex flex-col sm:flex-row gap-2 mb-2">
                    <!-- Numbers Board (5x15) -->
                    <div class="flex-1">
                        <div class="grid grid-cols-5 gap-1">
                            <div class="text-center font-bold text-yellow-400 text-xs">B</div>
                            <div class="text-center font-bold text-yellow-400 text-xs">I</div>
                            <div class="text-center font-bold text-yellow-400 text-xs">N</div>
                            <div class="text-center font-bold text-yellow-400 text-xs">G</div>
                            <div class="text-center font-bold text-yellow-400 text-xs">O</div>

                            <template x-for="row in 15" :key="row">
                                <template x-for="col in 5" :key="col">
                                    <div class="flex flex-col items-center">
                                        <div 
                                            class="small-number-circle"
                                            :class="{'small-number-circle-drawn': calledNumbers.includes(getNumber(col, row))}"
                                        >
                                            <span x-text="getNumber(col, row)"></span>
                                        </div>
                                    </div>
                                </template>
                            </template>
                        </div>
                    </div>

                    <!-- Drawn Numbers Info -->
                    <div class="flex flex-col items-center gap-2">
                        <p class="text-sm">Total Drawn: <span x-text="calledNumbers.length"></span></p>
                        <div x-show="currentCalledNumber !== null" class="animated-number">
                            <span x-text="currentCalledNumberLetter"></span>
                            <span x-text="currentCalledNumber"></span>
                        </div>
                        <div x-show="currentCalledNumber === null" class="animated-number-placeholder"></div>
                        <div class="history-container">
                            <div class="flex justify-center gap-1 mb-1">
                                <template x-for="call in lastFiveCalls" :key="call.number">
                                    <div 
                                        class="roll-number"
                                        :class="{
                                            'roll-number-b': call.letter === 'B',
                                            'roll-number-i': call.letter === 'I',
                                            'roll-number-n': call.letter === 'N',
                                            'roll-number-g': call.letter === 'G',
                                            'roll-number-o': call.letter === 'O'
                                        }"
                                    >
                                        <span x-text="call.letter"></span>
                                        <span x-text="call.number"></span>
                                    </div>
                                </template>
                            </div>
                            <p class="text-xs text-gray-400 text-center">Last 5 Calls</p>
                            <div class="history-divider"></div>
                            <div class="previous-number">
                                <span x-text="previousNumberLetter || '0'"></span>
                                <span x-text="previousNumber || '0'"></span>
                            </div>
                            <p class="text-xs text-gray-400 text-center">Previous Number</p>
                        </div>
                        <div class="call-history">
                            <span x-text="calledNumbers.length"></span>
                            <span x-text="lastFiveCalls.length > 0 ? lastFiveCalls[0].letter + '-' + lastFiveCalls[0].number : 'N/A'"></span>
                        </div>
                        <p class="text-xs text-gray-400 text-center">Call History</p>
                    </div>
                </div>

                <!-- User's Cartellas -->
                <div class="space-y-2 mb-2">
                    <template x-for="(cartella, index) in cartellas" :key="index">
                        <div class="cartella" :class="{'cartella-winner': cartella.isWinner}">
                            <h3 class="text-center font-bold text-sm mb-1" x-text="'Cartella ' + cartella.id"></h3>
                            <div class="grid grid-cols-5 gap-1">
                                <div class="text-center font-bold text-yellow-400 text-xs">B</div>
                                <div class="text-center font-bold text-yellow-400 text-xs">I</div>
                                <div class="text-center font-bold text-yellow-400 text-xs">N</div>
                                <div class="text-center font-bold text-yellow-400 text-xs">G</div>
                                <div class="text-center font-bold text-yellow-400 text-xs">O</div>

                                <template x-for="row in 5" :key="row">
                                    <template x-for="col in 5" :key="col">
                                        <div 
                                            class="number-circle"
                                            :class="{
                                                'number-circle-marked': cartella.markedNumbers.includes(cartella.grid[row-1][col-1]),
                                                'bg-yellow-600': cartella.grid[row-1][col-1] === '*',
                                                'winning-number': cartella.isWinner && isWinningNumber(cartella, row-1, col-1),
                                                'non-winning-number': cartella.isWinner && !isWinningNumber(cartella, row-1, col-1)
                                            }"
                                            @click="cartella.grid[row-1][col-1] !== '*' && toggleMark(cartella, cartella.grid[row-1][col-1])"
                                            :aria-label="'Number ' + cartella.grid[row-1][col-1] + (cartella.markedNumbers.includes(cartella.grid[row-1][col-1]) ? ' (marked)' : '')"
                                            role="button"
                                        >
                                            <span x-text="cartella.grid[row-1][col-1]"></span>
                                        </div>
                                    </template>
                                </template>
                            </div>
                            <p class="text-green-400 mt-1 text-center text-xs" x-show="cartella.isWinner" x-text="'Winner! Patterns: ' + cartella.patterns.join(', ')"></p>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Winner Popup -->
            <div 
                x-show="showWinnerPopup"
                class="winner-popup"
                role="alert"
                aria-label="Game over notification"
            >
                <p class="text-base font-bold">Game Over!</p>
                <p class="text-xs" x-text="'Cartella ' + winningCartella + ' won the game.'"></p>
            </div>
        </div>
    </main>

    <!-- Pinned Bingo Button -->
    <div class="pinned-footer" x-show="gameStarted">
        <button 
            class="button button-green w-full py-2 text-base flex justify-between items-center px-3"
            @click="claimWin()"
            :disabled="!hasWinner || calledNumbers.length < 4"
            :class="{'button-disabled': !hasWinner || calledNumbers.length < 4}"
            aria-label="Claim Bingo Win"
        >
            <span>BINGO</span>
            <span x-show="hasWinner && calledNumbers.length >= 4" x-text="winAmount + ' birr'"></span>
        </button>
    </div>
    <script src="/static/bingo.js"></script>
</body>
</html>